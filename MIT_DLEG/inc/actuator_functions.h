/****************************************************************************
	PRIVATE FUNCTIONS
*****************************************************************************
	[Lead developers] Matt Carney, mcarney at mit dot edu
	Biomechatronics research group <http://biomech.media.mit.edu/>
	[Contributors] Matthew Carney, mcarney at mit dot edu, Tony Shu, tonyshu at mit dot edu
*****************************************************************************
	[This file] MIT DARPA Leg Actuator Specific functions

	These are lower level functions that should not be messed with.

****************************************************************************/
#ifndef INC_ACTUATOR_FUNCTIONS_H
#define INC_ACTUATOR_FUNCTIONS_H

//****************************************************************************
// Include(s)
//****************************************************************************
#include <stdint.h>
#include "main.h"
#include "actuator_functions.h"
#include "user-mn.h"
#include "user-mn-ActPack.h"
#include "mn-MotorControl.h"
#include "flexsea_sys_def.h"
#include "flexsea_system.h"
#include "flexsea_cmd_calibration.h"
#include "flexsea_user_structs.h"
#include "user-mn-MIT-DLeg.h"

#include <math.h>
#include <stdbool.h>

//#include "walking_state_machine.h"
#include "walking_knee_ankle_state_machine.h"
#include "state_variables.h"
#include "safety_functions.h"
//DEBUG
#include "software_filter.h"

#define MOMENTARM_N 1000
static float MOMENTARM_R[MOMENTARM_N] = {0.0250915870010335,0.025159490628374,0.0252273340818261,0.0252951171610271,0.0253628396653847,0.0254305013940772,0.025498102146051,0.0255656417200205,0.0256331199144662,0.0257005365276338,0.025767891357533,0.0258351842019363,0.0259024148583775,0.0259695831241509,0.02603668879631,0.0261037316716658,0.0261707115467863,0.0262376282179949,0.0263044814813687,0.0263712711327384,0.0264379969676858,0.0265046587815434,0.0265712563693928,0.0266377895260632,0.0267042580461309,0.026770661723917,0.026837000353487,0.026903273728649,0.0269694816429526,0.0270356238896874,0.027101700261882,0.0271677105523026,0.0272336545534513,0.0272995320575653,0.0273653428566154,0.0274310867423045,0.0274967635060665,0.0275623729390647,0.0276279148321907,0.0276933889760629,0.027758795161025,0.0278241331771451,0.0278894028142138,0.0279546038617431,0.0280197361089649,0.0280847993448298,0.0281497933580054,0.0282147179368751,0.0282795728695368,0.0283443579438011,0.0284090729471902,0.0284737176669364,0.0285382918899807,0.0286027954029713,0.0286672279922619,0.0287315894439108,0.0287958795436792,0.0288600980770293,0.0289242448291236,0.0289883195848229,0.0290523221286848,0.0291162522449626,0.0291801097176034,0.0292438943302468,0.0293076058662235,0.0293712441085533,0.0294348088399443,0.0294982998427907,0.0295617168991717,0.0296250597908497,0.0296883282992691,0.0297515222055541,0.029814641290508,0.0298776853346108,0.0299406541180183,0.03000354742056,0.030066365021738,0.0301291067007248,0.0301917722363623,0.0302543614071599,0.0303168739912929,0.0303793097666008,0.030441668510586,0.0305039500004117,0.0305661540129006,0.0306282803245333,0.0306903287114461,0.0307522989494302,0.0308141908139293,0.0308760040800382,0.0309377385225012,0.0309993939157101,0.031060970033703,0.0311224666501623,0.0311838835384126,0.0312452204714198,0.031306477221789,0.0313676535617622,0.0314287492632178,0.0314897640976675,0.0315506978362555,0.0316115502497565,0.0316723211085736,0.031733010182737,0.0317936172419018,0.0318541420553465,0.0319145843919711,0.0319749440202953,0.0320352207084567,0.0320954142242088,0.0321555243349195,0.032215550807569,0.0322754934087483,0.0323353519046566,0.0323951260611005,0.0324548156434911,0.0325144204168429,0.0325739401457715,0.0326333745944918,0.0326927235268162,0.0327519867061526,0.0328111638955025,0.0328702548574591,0.0329292593542054,0.0329881771475121,0.0330470079987359,0.0331057516688174,0.033164407918279,0.0332229765072235,0.0332814571953313,0.033339849741859,0.0333981539056373,0.0334563694450689,0.0335144961181265,0.0335725336823507,0.0336304818948486,0.0336883405122905,0.0337461092909093,0.0338037879864974,0.033861376354405,0.0339188741495382,0.0339762811263567,0.0340335970388719,0.0340908216406445,0.0341479546847827,0.0342049959239401,0.0342619451103132,0.0343188019956397,0.0343755663311964,0.0344322378677966,0.0344888163557884,0.0345453015450522,0.0346016931849988,0.0346579910245672,0.0347141948122223,0.0347703042959526,0.0348263192232684,0.034882239341199,0.0349380643962912,0.0349937941346064,0.0350494283017189,0.0351049666427131,0.0351604089021818,0.0352157548242237,0.035271004152441,0.0353261566299373,0.0353812119993153,0.0354361700026743,0.0354910303816083,0.0355457928772032,0.0356004572300349,0.0356550231801666,0.0357094904671468,0.0357638588300066,0.0358181280072579,0.0358722977368901,0.0359263677563688,0.0359803378026325,0.0360342076120909,0.036087976920622,0.03614164546357,0.0361952129757427,0.036248679191409,0.0363020438442967,0.03635530666759,0.0364084673939269,0.0364615257553967,0.0365144814835377,0.0365673343093348,0.0366200839632165,0.036672730175053,0.0367252726741534,0.0367777111892629,0.036830045448561,0.0368822751796582,0.0369344001095938,0.0369864199648333,0.037038334471266,0.0370901433542022,0.0371418463383703,0.0371934431479151,0.0372449335063943,0.0372963171367763,0.0373475937614375,0.0373987631021598,0.0374498248801276,0.0375007788159255,0.0375516246295356,0.0376023620403345,0.0376529907670909,0.037703510527963,0.0377539210404956,0.0378042220216172,0.0378544131876377,0.0379044942542457,0.037954464936505,0.0380043249488529,0.0380540740050966,0.0381037118184109,0.0381532381013353,0.0382026525657711,0.0382519549229788,0.038301144883575,0.0383502221575301,0.0383991864541647,0.0384480374821476,0.0384967749494923,0.0385453985635545,0.0385939080310293,0.0386423030579478,0.0386905833496748,0.0387387486109058,0.0387867985456638,0.0388347328572966,0.0388825512484739,0.0389302534211843,0.0389778390767324,0.0390253079157358,0.0390726596381222,0.0391198939431264,0.0391670105292871,0.0392140090944446,0.0392608893357368,0.0393076509495972,0.0393542936317512,0.0394008170772131,0.0394472209802837,0.0394935050345462,0.0395396689328644,0.0395857123673786,0.0396316350295029,0.0396774366099223,0.0397231167985894,0.0397686752847212,0.0398141117567964,0.0398594259025517,0.0399046174089792,0.039949685962323,0.0399946312480761,0.0400394529509772,0.0400841507550075,0.0401287243433878,0.040173173398575,0.0402174976022591,0.0402616966353598,0.0403057701780236,0.0403497179096201,0.0403935395087394,0.0404372346531884,0.0404808030199875,0.0405242442853679,0.0405675581247677,0.0406107442128289,0.0406538022233942,0.0406967318295036,0.0407395327033911,0.0407822045164814,0.0408247469393867,0.0408671596419032,0.0409094422930077,0.0409515945608547,0.0409936161127725,0.0410355066152602,0.0410772657339842,0.041118893133775,0.0411603884786233,0.0412017514316774,0.0412429816552391,0.0412840788107607,0.0413250425588413,0.0413658725592237,0.0414065684707908,0.0414471299515621,0.0414875566586902,0.0415278482484577,0.0415680043762733,0.0416080246966686,0.0416479088632946,0.0416876565289182,0.0417272673454184,0.0417667409637835,0.0418060770341067,0.0418452752055835,0.0418843351265074,0.0419232564442669,0.0419620388053418,0.0420006818552993,0.0420391852387913,0.0420775485995499,0.0421157715803844,0.0421538538231777,0.0421917949688826,0.042229594657518,0.0422672525281659,0.0423047682189673,0.0423421413671187,0.0423793716088686,0.0424164585795141,0.0424534019133966,0.0424902012438989,0.0425268562034412,0.0425633664234776,0.0425997315344924,0.0426359511659963,0.0426720249465232,0.042707952503626,0.0427437334638735,0.0427793674528462,0.0428148540951329,0.0428501930143271,0.0428853838330232,0.0429204261728128,0.0429553196542811,0.0429900638970032,0.0430246585195404,0.0430591031394364,0.0430933973732136,0.0431275408363697,0.0431615331433738,0.0431953739076623,0.043229062741636,0.0432625992566556,0.0432959830630385,0.0433292137700549,0.0433622909859239,0.0433952143178103,0.0434279833718201,0.0434605977529974,0.0434930570653207,0.0435253609116984,0.0435575088939661,0.0435895006128822,0.0436213356681241,0.043653013658285,0.0436845341808698,0.0437158968322913,0.0437471012078667,0.0437781469018137,0.0438090335072468,0.0438397606161736,0.0438703278194909,0.0439007347069814,0.0439309808673094,0.0439610658880175,0.0439909893555226,0.0440207508551122,0.0440503499709411,0.0440797862860268,0.0441090593822467,0.0441381688403339,0.0441671142398735,0.0441958951592989,0.0442245111758882,0.0442529618657604,0.0442812468038717,0.044309365564012,0.0443373177188008,0.0443651028396839,0.0443927204969294,0.0444201702596242,0.0444474516956705,0.0444745643717816,0.0445015078534788,0.0445282817050875,0.0445548854897334,0.0445813187693391,0.0446075811046204,0.0446336720550827,0.0446595911790171,0.0446853380334973,0.0447109121743755,0.044736313156279,0.0447615405326067,0.0447865938555256,0.0448114726759668,0.0448361765436224,0.0448607050069416,0.0448850576131276,0.0449092339081336,0.0449332334366595,0.0449570557421486,0.0449807003667836,0.0450041668514837,0.0450274547359008,0.045050563558416,0.0450734928561363,0.0450962421648913,0.0451188110192295,0.0451411989524151,0.0451634054964246,0.0451854301819434,0.0452072725383623,0.0452289320937747,0.0452504083749725,0.0452717009074435,0.0452928092153679,0.0453137328216147,0.0453344712477389,0.0453550240139782,0.0453753906392497,0.0453955706411466,0.0454155635359354,0.0454353688385523,0.0454549860626006,0.0454744147203471,0.0454936543227193,0.0455127043793024,0.0455315643983361,0.0455502338867116,0.045568712349969,0.0455869992922936,0.0456050942165139,0.0456229966240977,0.0456407060151502,0.0456582218884104,0.0456755437412487,0.0456926710696639,0.0457096033682807,0.0457263401303466,0.0457428808477294,0.0457592250109146,0.0457753721090028,0.0457913216297066,0.0458070730593487,0.045822625882859,0.045837979583772,0.0458531336442247,0.0458680875449538,0.0458828407652935,0.0458973927831728,0.0459117430751139,0.045925891116229,0.0459398363802187,0.0459535783393696,0.0459671164645521,0.0459804502252181,0.0459935790893994,0.0460065025237049,0.0460192199933195,0.0460317309620012,0.04604403489208,0.0460561312444555,0.0460680194785952,0.0460796990525328,0.0460911694228665,0.046102430044757,0.0461134803719264,0.0461243198566561,0.0461349479497855,0.0461453641007105,0.046155567757382,0.0461655583663046,0.0461753353725353,0.0461848982196821,0.0461942463499027,0.0462033792039037,0.0462122962209393,0.0462209968388099,0.0462294804938619,0.046237746620986,0.0462457946536167,0.0462536240237315,0.0462612341618502,0.0462686244970339,0.0462757944568848,0.0462827434675454,0.0462894709536981,0.0462959763385647,0.0463022590439064,0.0463083184900229,0.0463141540957527,0.0463197652784729,0.046325151454099,0.0463303120370849,0.0463352464404231,0.046339954075645,0.0463444343528206,0.0463486866805595,0.0463527104660109,0.0463565051148642,0.0463600700313494,0.0463634046182379,0.0463665082768434,0.0463693804070222,0.0463720204071746,0.0463744276742456,0.0463766016037261,0.0463785415896541,0.0463802470246157,0.0463817172997468,0.0463829518047342,0.0463839499278174,0.04638471105579,0.0463852345740018,0.0463855198663601,0.0463855663153319,0.0463853733019462,0.0463849402057955,0.0463842664050386,0.0463833512764026,0.0463821941951855,0.0463807945352586,0.0463791516690693,0.0463772649676439,0.0463751338005904,0.0463727575361012,0.046370135540957,0.0463672671805289,0.0463641518187829,0.0463607888182826,0.0463571775401929,0.0463533173442838,0.0463492075889344,0.0463448476311366,0.046340236826499,0.0463353745292517,0.04633026009225,0.0463248928669793,0.0463192722035593,0.0463133974507492,0.0463072679559522,0.0463008830652206,0.046294242123261,0.0462873444734396,0.0462801894577873,0.0462727764170059,0.0462651046904731,0.0462571736162489,0.0462489825310813,0.0462405307704126,0.0462318176683857,0.0462228425578504,0.0462136047703703,0.0462041036362293,0.0461943384844387,0.0461843086427444,0.0461740134376337,0.0461634521943432,0.0461526242368663,0.0461415288879608,0.0461301654691569,0.0461185333007653,0.0461066317018855,0.0460944599904142,0.0460820174830538,0.0460693034953218,0.0460563173415588,0.0460430583349385,0.0460295257874767,0.0460157190100408,0.0460016373123599,0.045987280003034,0.045972646389545,0.0459577357782662,0.0459425474744734,0.0459270807823553,0.0459113350050245,0.0458953094445283,0.0458790034018607,0.0458624161769733,0.0458455470687872,0.045828395375205,0.0458109603931229,0.0457932414184431,0.0457752377460863,0.0457569486700048,0.045738373483195,0.045719511477711,0.0457003619446782,0.0456809241743067,0.0456611974559051,0.0456411810778954,0.0456208743278265,0.0456002764923894,0.045579386857432,0.0455582047079739,0.0455367293282223,0.0455149600015871,0.0454928960106969,0.0454705366374153,0.0454478811628571,0.0454249288674049,0.0454016790307258,0.045378130931789,0.0453542838488828,0.0453301370596323,0.0453056898410173,0.0452809414693908,0.045255891220497,0.0452305383694902,0.0452048821909541,0.0451789219589206,0.0451526569468897,0.0451260864278491,0.0450992096742947,0.0450720259582506,0.04504453455129,0.0450167347245562,0.044988625748784,0.044960206894321,0.0449314774311498,0.0449024366289098,0.0448730837569202,0.0448434180842025,0.0448134388795035,0.044783145411319,0.0447525369479173,0.0447216127573633,0.0446903721075431,0.0446588142661883,0.0446269385009012,0.0445947440791802,0.0445622302684454,0.0445293963360645,0.0444962415493793,0.0444627651757321,0.0444289664824931,0.0443948447370872,0.0443603992070221,0.0443256291599161,0.0442905338635268,0.0442551125857792,0.0442193645947953,0.0441832891589233,0.0441468855467674,0.0441101530272181,0.0440730908694823,0.0440356983431145,0.0439979747180479,0.0439599192646261,0.0439215312536349,0.0438828099563345,0.0438437546444926,0.0438043645904174,0.0437646390669905,0.0437245773477015,0.0436841787066818,0.0436434424187393,0.0436023677593934,0.0435609540049104,0.0435192004323391,0.0434771063195472,0.0434346709452578,0.0433918935890865,0.0433487735315782,0.0433053100542457,0.0432615024396072,0.0432173499712251,0.0431728519337451,0.0431280076129354,0.0430828162957267,0.0430372772702522,0.0429913898258884,0.0429451532532961,0.0428985668444618,0.0428516298927398,0.0428043416928942,0.0427567015411419,0.0427087087351956,0.0426603625743078,0.0426116623593139,0.0425626073926779,0.0425131969785361,0.0424634304227433,0.0424133070329181,0.0423628261184893,0.0423119869907422,0.0422607889628663,0.0422092313500022,0.0421573134692898,0.0421050346399168,0.0420523941831674,0.0419993914224717,0.0419460256834553,0.0418922962939898,0.0418382025842428,0.0417837438867301,0.0417289195363658,0.0416737288705157,0.0416181712290488,0.0415622459543905,0.0415059523915762,0.0414492898883046,0.0413922577949926,0.0413348554648296,0.0412770822538325,0.0412189375209022,0.0411604206278786,0.0411015309395981,0.04104226782395,0.0409826306519342,0.0409226187977194,0.0408622316387011,0.0408014685555604,0.0407403289323239,0.0406788121564229,0.0406169176187539,0.0405546447137393,0.0404919928393882,0.0404289613973588,0.0403655497930196,0.0403017574355125,0.0402375837378155,0.0401730281168062,0.0401080899933258,0.0400427687922434,0.0399770639425208,0.0399109748772775,0.0398445010338569,0.039777641853892,0.0397103967833723,0.0396427652727108,0.0395747467768111,0.039506340755136,0.0394375466717755,0.0393683639955153,0.039298792199907,0.0392288307633367,0.0391584791690958,0.0390877369054516,0.0390166034657178,0.0389450783483262,0.0388731610568988,0.0388008511003196,0.0387281479928075,0.0386550512539893,0.0385815604089735,0.0385076749884239,0.0384333945286341,0.038358718571602,0.0382836466651053,0.0382081783627769,0.0381323132241805,0.0380560508148875,0.0379793907065532,0.0379023324769942,0.0378248757102656,0.0377470199967391,0.0376687649331811,0.0375901101228311,0.0375110551754809,0.0374315997075538,0.037351743342184,0.0372714857092972,0.0371908264456901,0.0371097651951117,0.037028301608344,0.0369464353432834,0.0368641660650222,0.0367814934459309,0.03669841716574,0.0366149369116227,0.036531052378278,0.0364467632680136,0.0363620692908292,0.0362769701645007,0.0361914656146633,0.0361055553748968,0.036019239186809,0.0359325168001213,0.0358453879727531,0.0357578524709074,0.0356699100691558,0.0355815605505244,0.0354928037065796,0.0354036393375142,0.0353140672522337,0.0352240872684422,0.0351336992127299,0.0350429029206589,0.0349516982368509,0.0348600850150739,0.0347680631183292,0.0346756324189394,0.0345827927986351,0.0344895441486431,0.0343958863697735,0.0343018193725082,0.0342073430770876,0.0341124574135999,0.034017162322068,0.0339214577525379,0.0338253436651669,0.0337288200303115,0.0336318868286154,0.0335345440510978,0.0334367916992417,0.0333386297850813,0.0332400583312908,0.033141077371272,0.0330416869492424,0.0329418871203228,0.0328416779506258,0.0327410595173426,0.0326400319088315,0.0325385952247048,0.0324367495759163,0.0323344950848489,0.0322318318854011,0.0321287601230745,0.0320252799550598,0.0319213915503242,0.0318170950896969,0.0317123907659559,0.0316072787839134,0.0315017593605013,0.0313958327248572,0.0312894991184087,0.0311827587949586,0.0310756120207692,0.0309680590746466,0.0308601002480242,0.0307517358450462,0.0306429661826509,0.0305337915906533,0.0304242124118268,0.0303142290019859,0.0302038417300671,0.0300930509782099,0.0299818571418374,0.0298702606297364,0.0297582618641365,0.0296458612807897,0.0295330593290484,0.0294198564719433,0.029306253186261,0.029192249962621,0.029077847305551,0.0289630457335634,0.0288478457792295,0.0287322479892542,0.0286162529245495,0.0284998611603072,0.0283830732860715,0.0282658899058101,0.0281483116379852,0.0280303391156232,0.0279119729863843,0.0277932139126307,0.0276740625714942,0.0275545196549431,0.027434585869848,0.0273142619380469,0.0271935485964097,0.0270724465969011,0.0269509567066429,0.0268290797079759,0.0267068163985203,0.0265841675912347,0.0264611341144752,0.0263377168120528,0.0262139165432894,0.026089734183074,0.0259651706219167,0.0258402267660017,0.02571490353724,0.0255892018733203,0.0254631227277589,0.0253366670699483,0.0252098358852052,0.0250826301748168,0.0249550509560856,0.0248270992623741,0.024698776143147,0.0245700826640127,0.0244410199067639,0.0243115889694159,0.0241817909662448,0.0240516270278234,0.0239210983010561,0.0237902059492124,0.0236589511519593,0.0235273351053917,0.023395359022062,0.0232630241310077,0.0231303316777783,0.0229972829244597,0.0228638791496978,0.0227301216487209,0.0225960117333597,0.0224615507320663,0.0223267399899317,0.0221915808687014,0.0220560747467897,0.0219202230192924,0.0217840270979977,0.0216474884113956,0.0215106084046855,0.0213733885397824,0.0212358302953213,0.0210979351666599,0.0209597046658795,0.0208211403217845,0.0206822436798995,0.0205430163024658,0.0204034597684349,0.0202635756734611,0.0201233656298918,0.0199828312667564,0.019841974229753,0.0197007961812341,0.0195592988001889,0.0194174837822257,0.0192753528395507,0.0191329077009464,0.0189901501117467,0.0188470818338119,0.0187037046454998,0.0185600203416362,0.0184160307334835,0.0182717376487069,0.0181271429313384,0.0179822484417399,0.0178370560565634,0.0176915676687099,0.0175457851872856,0.0173997105375571,0.017253345660904,0.0171066925147692,0.0169597530726084,0.0168125293238361,0.0166650232737714,0.0165172369435799,0.0163691723702148,0.0162208316063561,0.0160722167203466,0.0159233297961278,0.0157741729331715,0.0156247482464117,0.0154750578661726,0.0153251039380956,0.0151748886230644,0.0150244140971271,0.0148736825514174,0.0147226961920735,0.014571457240154,0.0144199679315537,0.0142682305169152,0.0141162472615407,0.0139640204452998,0.0138115523625365,0.0136588453219743,0.0135059016466184,0.0133527236736567,0.0131993137543585,0.0130456742539714,0.0128918075516162,0.0127377160401794,0.0125834021262045,0.012428868229781,0.0122741167844312,0.0121191502369956,0.011963971047516,0.0118085816891167,0.0116529846478841,0.0114971824227442,0.0113411775253382,0.0111849724798964,0.01102856982311,0.0108719721040013,0.010715181883792,0.0105582017357697,0.0104010342451525,0.0102436820089522,0.0100861476358346,0.0099284337459801,0.00977054297094047,0.00961247795349503,0.00945424134750488,0.0092958358177655,0.00913726403985754,0.0089785286999962,0.00881963249487845,0.00866057813152979,0.00850136832714743,0.00834200580894442,0.00818249331399014,0.00802283358905014,0.00786302939042464,0.00770308348378501};
static float MOMENTARM_THETA[MOMENTARM_N] = {-0.785398163397448,-0.783126964170629,-0.780855764943809,-0.77858456571699,-0.77631336649017,-0.774042167263351,-0.771770968036532,-0.769499768809712,-0.767228569582893,-0.764957370356073,-0.762686171129254,-0.760414971902434,-0.758143772675615,-0.755872573448795,-0.753601374221976,-0.751330174995157,-0.749058975768337,-0.746787776541518,-0.744516577314698,-0.742245378087879,-0.739974178861059,-0.73770297963424,-0.73543178040742,-0.733160581180601,-0.730889381953782,-0.728618182726962,-0.726346983500143,-0.724075784273323,-0.721804585046504,-0.719533385819684,-0.717262186592865,-0.714990987366045,-0.712719788139226,-0.710448588912406,-0.708177389685587,-0.705906190458768,-0.703634991231948,-0.701363792005129,-0.699092592778309,-0.69682139355149,-0.69455019432467,-0.692278995097851,-0.690007795871031,-0.687736596644212,-0.685465397417393,-0.683194198190573,-0.680922998963754,-0.678651799736934,-0.676380600510115,-0.674109401283295,-0.671838202056476,-0.669567002829656,-0.667295803602837,-0.665024604376018,-0.662753405149198,-0.660482205922379,-0.658211006695559,-0.65593980746874,-0.65366860824192,-0.651397409015101,-0.649126209788281,-0.646855010561462,-0.644583811334642,-0.642312612107823,-0.640041412881004,-0.637770213654184,-0.635499014427365,-0.633227815200545,-0.630956615973726,-0.628685416746906,-0.626414217520087,-0.624143018293267,-0.621871819066448,-0.619600619839629,-0.617329420612809,-0.61505822138599,-0.61278702215917,-0.610515822932351,-0.608244623705531,-0.605973424478712,-0.603702225251892,-0.601431026025073,-0.599159826798254,-0.596888627571434,-0.594617428344615,-0.592346229117795,-0.590075029890976,-0.587803830664156,-0.585532631437337,-0.583261432210517,-0.580990232983698,-0.578719033756878,-0.576447834530059,-0.57417663530324,-0.57190543607642,-0.569634236849601,-0.567363037622781,-0.565091838395962,-0.562820639169142,-0.560549439942323,-0.558278240715503,-0.556007041488684,-0.553735842261865,-0.551464643035045,-0.549193443808226,-0.546922244581406,-0.544651045354587,-0.542379846127767,-0.540108646900948,-0.537837447674128,-0.535566248447309,-0.53329504922049,-0.53102384999367,-0.528752650766851,-0.526481451540031,-0.524210252313212,-0.521939053086392,-0.519667853859573,-0.517396654632754,-0.515125455405934,-0.512854256179115,-0.510583056952295,-0.508311857725476,-0.506040658498656,-0.503769459271837,-0.501498260045017,-0.499227060818198,-0.496955861591378,-0.494684662364559,-0.49241346313774,-0.49014226391092,-0.487871064684101,-0.485599865457281,-0.483328666230462,-0.481057467003642,-0.478786267776823,-0.476515068550003,-0.474243869323184,-0.471972670096364,-0.469701470869545,-0.467430271642726,-0.465159072415906,-0.462887873189087,-0.460616673962267,-0.458345474735448,-0.456074275508628,-0.453803076281809,-0.451531877054989,-0.44926067782817,-0.446989478601351,-0.444718279374531,-0.442447080147712,-0.440175880920892,-0.437904681694073,-0.435633482467253,-0.433362283240434,-0.431091084013614,-0.428819884786795,-0.426548685559975,-0.424277486333156,-0.422006287106337,-0.419735087879517,-0.417463888652698,-0.415192689425878,-0.412921490199059,-0.410650290972239,-0.40837909174542,-0.4061078925186,-0.403836693291781,-0.401565494064962,-0.399294294838142,-0.397023095611323,-0.394751896384503,-0.392480697157684,-0.390209497930864,-0.387938298704045,-0.385667099477225,-0.383395900250406,-0.381124701023587,-0.378853501796767,-0.376582302569948,-0.374311103343128,-0.372039904116309,-0.369768704889489,-0.36749750566267,-0.36522630643585,-0.362955107209031,-0.360683907982212,-0.358412708755392,-0.356141509528573,-0.353870310301753,-0.351599111074934,-0.349327911848114,-0.347056712621295,-0.344785513394475,-0.342514314167656,-0.340243114940837,-0.337971915714017,-0.335700716487198,-0.333429517260378,-0.331158318033559,-0.328887118806739,-0.32661591957992,-0.3243447203531,-0.322073521126281,-0.319802321899461,-0.317531122672642,-0.315259923445823,-0.312988724219003,-0.310717524992184,-0.308446325765364,-0.306175126538545,-0.303903927311725,-0.301632728084906,-0.299361528858086,-0.297090329631267,-0.294819130404448,-0.292547931177628,-0.290276731950809,-0.288005532723989,-0.28573433349717,-0.28346313427035,-0.281191935043531,-0.278920735816711,-0.276649536589892,-0.274378337363072,-0.272107138136253,-0.269835938909434,-0.267564739682614,-0.265293540455795,-0.263022341228975,-0.260751142002156,-0.258479942775336,-0.256208743548517,-0.253937544321697,-0.251666345094878,-0.249395145868059,-0.247123946641239,-0.24485274741442,-0.2425815481876,-0.240310348960781,-0.238039149733961,-0.235767950507142,-0.233496751280322,-0.231225552053503,-0.228954352826684,-0.226683153599864,-0.224411954373045,-0.222140755146225,-0.219869555919406,-0.217598356692586,-0.215327157465767,-0.213055958238947,-0.210784759012128,-0.208513559785308,-0.206242360558489,-0.20397116133167,-0.20169996210485,-0.199428762878031,-0.197157563651211,-0.194886364424392,-0.192615165197572,-0.190343965970753,-0.188072766743933,-0.185801567517114,-0.183530368290295,-0.181259169063475,-0.178987969836656,-0.176716770609836,-0.174445571383017,-0.172174372156197,-0.169903172929378,-0.167631973702558,-0.165360774475739,-0.16308957524892,-0.1608183760221,-0.158547176795281,-0.156275977568461,-0.154004778341642,-0.151733579114822,-0.149462379888003,-0.147191180661183,-0.144919981434364,-0.142648782207545,-0.140377582980725,-0.138106383753906,-0.135835184527086,-0.133563985300267,-0.131292786073447,-0.129021586846628,-0.126750387619808,-0.124479188392989,-0.12220798916617,-0.11993678993935,-0.117665590712531,-0.115394391485711,-0.113123192258892,-0.110851993032072,-0.108580793805253,-0.106309594578433,-0.104038395351614,-0.101767196124794,-0.0994959968979751,-0.0972247976711555,-0.094953598444336,-0.0926823992175168,-0.0904111999906972,-0.0881400007638777,-0.0858688015370583,-0.0835976023102388,-0.0813264030834194,-0.0790552038566,-0.0767840046297805,-0.074512805402961,-0.0722416061761417,-0.0699704069493222,-0.0676992077225027,-0.0654280084956833,-0.0631568092688639,-0.0608856100420444,-0.0586144108152249,-0.0563432115884055,-0.054072012361586,-0.0518008131347666,-0.0495296139079472,-0.0472584146811277,-0.0449872154543082,-0.0427160162274889,-0.0404448170006694,-0.0381736177738499,-0.0359024185470305,-0.0336312193202111,-0.0313600200933916,-0.0290888208665722,-0.0268176216397527,-0.0245464224129331,-0.0222752231861139,-0.0200040239592943,-0.0177328247324748,-0.0154616255056554,-0.013190426278836,-0.0109192270520165,-0.00864802782519714,-0.00637682859837763,-0.00410562937155823,-0.00183443014473883,0.000436769082080679,0.00270796830890019,0.0049791675357197,0.00725036676253898,0.00952156598935849,0.011792765216178,0.0140639644429974,0.0163351636698168,0.0186063628966363,0.0208775621234557,0.0231487613502752,0.0254199605770946,0.027691159803914,0.0299623590307335,0.032233558257553,0.0345047574843724,0.0367759567111918,0.0390471559380113,0.0413183551648307,0.0435895543916502,0.0458607536184696,0.048131952845289,0.0504031520721085,0.0526743512989281,0.0549455505257473,0.0572167497525669,0.0594879489793864,0.0617591482062059,0.0640303474330253,0.0663015466598447,0.0685727458866642,0.0708439451134836,0.0731151443403031,0.0753863435671225,0.0776575427939419,0.0799287420207614,0.0821999412475809,0.0844711404744002,0.0867423397012197,0.0890135389280392,0.0912847381548586,0.0935559373816781,0.0958271366084975,0.0980983358353169,0.100369535062136,0.102640734288956,0.104911933515775,0.107183132742595,0.109454331969414,0.111725531196234,0.113996730423053,0.116267929649873,0.118539128876692,0.120810328103511,0.123081527330331,0.12535272655715,0.12762392578397,0.129895125010789,0.132166324237609,0.134437523464428,0.136708722691248,0.138979921918067,0.141251121144886,0.143522320371706,0.145793519598525,0.148064718825345,0.150335918052164,0.152607117278984,0.154878316505803,0.157149515732623,0.159420714959442,0.161691914186261,0.163963113413081,0.1662343126399,0.16850551186672,0.170776711093539,0.173047910320359,0.175319109547178,0.177590308773998,0.179861508000817,0.182132707227637,0.184403906454456,0.186675105681275,0.188946304908095,0.191217504134914,0.193488703361734,0.195759902588553,0.198031101815373,0.200302301042192,0.202573500269012,0.204844699495831,0.20711589872265,0.20938709794947,0.211658297176289,0.213929496403109,0.216200695629928,0.218471894856748,0.220743094083567,0.223014293310387,0.225285492537206,0.227556691764025,0.229827890990845,0.232099090217664,0.234370289444484,0.236641488671303,0.238912687898123,0.241183887124942,0.243455086351761,0.245726285578581,0.247997484805401,0.25026868403222,0.25253988325904,0.254811082485859,0.257082281712678,0.259353480939498,0.261624680166317,0.263895879393137,0.266167078619956,0.268438277846776,0.270709477073595,0.272980676300414,0.275251875527234,0.277523074754053,0.279794273980873,0.282065473207692,0.284336672434512,0.286607871661331,0.288879070888151,0.29115027011497,0.29342146934179,0.295692668568609,0.297963867795428,0.300235067022248,0.302506266249067,0.304777465475887,0.307048664702706,0.309319863929526,0.311591063156345,0.313862262383164,0.316133461609984,0.318404660836803,0.320675860063623,0.322947059290442,0.325218258517262,0.327489457744081,0.329760656970901,0.33203185619772,0.334303055424539,0.336574254651359,0.338845453878178,0.341116653104998,0.343387852331817,0.345659051558637,0.347930250785456,0.350201450012276,0.352472649239095,0.354743848465915,0.357015047692734,0.359286246919553,0.361557446146373,0.363828645373192,0.366099844600012,0.368371043826831,0.370642243053651,0.37291344228047,0.375184641507289,0.377455840734109,0.379727039960928,0.381998239187748,0.384269438414568,0.386540637641387,0.388811836868206,0.391083036095026,0.393354235321845,0.395625434548665,0.397896633775484,0.400167833002304,0.402439032229123,0.404710231455942,0.406981430682762,0.409252629909581,0.411523829136401,0.41379502836322,0.41606622759004,0.418337426816859,0.420608626043679,0.422879825270498,0.425151024497318,0.427422223724137,0.429693422950956,0.431964622177776,0.434235821404595,0.436507020631415,0.438778219858234,0.441049419085054,0.443320618311873,0.445591817538692,0.447863016765512,0.450134215992331,0.452405415219151,0.45467661444597,0.45694781367279,0.459219012899609,0.461490212126429,0.463761411353248,0.466032610580068,0.468303809806887,0.470575009033706,0.472846208260526,0.475117407487345,0.477388606714165,0.479659805940984,0.481931005167804,0.484202204394623,0.486473403621442,0.488744602848262,0.491015802075081,0.493287001301901,0.49555820052872,0.49782939975554,0.500100598982359,0.502371798209179,0.504642997435998,0.506914196662818,0.509185395889637,0.511456595116456,0.513727794343276,0.515998993570095,0.518270192796915,0.520541392023734,0.522812591250554,0.525083790477373,0.527354989704192,0.529626188931012,0.531897388157831,0.534168587384651,0.536439786611471,0.53871098583829,0.540982185065109,0.543253384291929,0.545524583518748,0.547795782745568,0.550066981972387,0.552338181199207,0.554609380426026,0.556880579652845,0.559151778879665,0.561422978106484,0.563694177333304,0.565965376560123,0.568236575786943,0.570507775013762,0.572778974240582,0.575050173467401,0.577321372694221,0.57959257192104,0.581863771147859,0.584134970374679,0.586406169601498,0.588677368828318,0.590948568055137,0.593219767281957,0.595490966508776,0.597762165735595,0.600033364962415,0.602304564189234,0.604575763416054,0.606846962642873,0.609118161869693,0.611389361096512,0.613660560323332,0.615931759550151,0.618202958776971,0.62047415800379,0.622745357230609,0.625016556457429,0.627287755684248,0.629558954911068,0.631830154137887,0.634101353364707,0.636372552591526,0.638643751818346,0.640914951045165,0.643186150271984,0.645457349498804,0.647728548725623,0.649999747952443,0.652270947179262,0.654542146406082,0.656813345632901,0.65908454485972,0.66135574408654,0.663626943313359,0.665898142540179,0.668169341766998,0.670440540993818,0.672711740220637,0.674982939447457,0.677254138674276,0.679525337901096,0.681796537127915,0.684067736354735,0.686338935581554,0.688610134808373,0.690881334035193,0.693152533262012,0.695423732488832,0.697694931715651,0.699966130942471,0.70223733016929,0.70450852939611,0.706779728622929,0.709050927849749,0.711322127076568,0.713593326303387,0.715864525530207,0.718135724757026,0.720406923983846,0.722678123210665,0.724949322437485,0.727220521664304,0.729491720891123,0.731762920117943,0.734034119344762,0.736305318571582,0.738576517798401,0.740847717025221,0.74311891625204,0.74539011547886,0.747661314705679,0.749932513932499,0.752203713159318,0.754474912386137,0.756746111612957,0.759017310839776,0.761288510066596,0.763559709293415,0.765830908520235,0.768102107747054,0.770373306973873,0.772644506200693,0.774915705427512,0.777186904654332,0.779458103881151,0.781729303107971,0.78400050233479,0.78627170156161,0.788542900788429,0.790814100015249,0.793085299242068,0.795356498468888,0.797627697695707,0.799898896922526,0.802170096149346,0.804441295376165,0.806712494602985,0.808983693829804,0.811254893056623,0.813526092283443,0.815797291510262,0.818068490737082,0.820339689963901,0.822610889190721,0.82488208841754,0.82715328764436,0.829424486871179,0.831695686097999,0.833966885324818,0.836238084551638,0.838509283778457,0.840780483005276,0.843051682232096,0.845322881458915,0.847594080685735,0.849865279912554,0.852136479139374,0.854407678366193,0.856678877593013,0.858950076819832,0.861221276046652,0.863492475273471,0.86576367450029,0.86803487372711,0.870306072953929,0.872577272180749,0.874848471407568,0.877119670634388,0.879390869861207,0.881662069088026,0.883933268314846,0.886204467541665,0.888475666768485,0.890746865995304,0.893018065222124,0.895289264448943,0.897560463675763,0.899831662902582,0.902102862129402,0.904374061356221,0.90664526058304,0.90891645980986,0.911187659036679,0.913458858263499,0.915730057490318,0.918001256717138,0.920272455943957,0.922543655170777,0.924814854397596,0.927086053624415,0.929357252851235,0.931628452078054,0.933899651304874,0.936170850531693,0.938442049758513,0.940713248985332,0.942984448212152,0.945255647438971,0.94752684666579,0.94979804589261,0.952069245119429,0.954340444346249,0.956611643573068,0.958882842799888,0.961154042026707,0.963425241253527,0.965696440480346,0.967967639707165,0.970238838933985,0.972510038160805,0.974781237387624,0.977052436614443,0.979323635841263,0.981594835068082,0.983866034294901,0.986137233521721,0.988408432748541,0.99067963197536,0.99295083120218,0.995222030428999,0.997493229655818,0.999764428882638,1.00203562810946,1.00430682733628,1.0065780265631,1.00884922578992,1.01112042501673,1.01339162424355,1.01566282347037,1.01793402269719,1.02020522192401,1.02247642115083,1.02474762037765,1.02701881960447,1.02929001883129,1.03156121805811,1.03383241728493,1.03610361651175,1.03837481573857,1.04064601496539,1.04291721419221,1.04518841341903,1.04745961264585,1.04973081187267,1.05200201109948,1.0542732103263,1.05654440955312,1.05881560877994,1.06108680800676,1.06335800723358,1.0656292064604,1.06790040568722,1.07017160491404,1.07244280414086,1.07471400336768,1.0769852025945,1.07925640182132,1.08152760104814,1.08379880027496,1.08606999950178,1.0883411987286,1.09061239795542,1.09288359718224,1.09515479640905,1.09742599563587,1.09969719486269,1.10196839408951,1.10423959331633,1.10651079254315,1.10878199176997,1.11105319099679,1.11332439022361,1.11559558945043,1.11786678867725,1.12013798790407,1.12240918713089,1.12468038635771,1.12695158558453,1.12922278481135,1.13149398403817,1.13376518326499,1.1360363824918,1.13830758171862,1.14057878094544,1.14284998017226,1.14512117939908,1.1473923786259,1.14966357785272,1.15193477707954,1.15420597630636,1.15647717553318,1.15874837476,1.16101957398682,1.16329077321364,1.16556197244046,1.16783317166728,1.1701043708941,1.17237557012092,1.17464676934774,1.17691796857455,1.17918916780137,1.18146036702819,1.18373156625501,1.18600276548183,1.18827396470865,1.19054516393547,1.19281636316229,1.19508756238911,1.19735876161593,1.19962996084275,1.20190116006957,1.20417235929639,1.20644355852321,1.20871475775003,1.21098595697685,1.21325715620367,1.21552835543049,1.2177995546573,1.22007075388412,1.22234195311094,1.22461315233776,1.22688435156458,1.2291555507914,1.23142675001822,1.23369794924504,1.23596914847186,1.23824034769868,1.2405115469255,1.24278274615232,1.24505394537914,1.24732514460596,1.24959634383278,1.2518675430596,1.25413874228642,1.25640994151324,1.25868114074005,1.26095233996687,1.26322353919369,1.26549473842051,1.26776593764733,1.27003713687415,1.27230833610097,1.27457953532779,1.27685073455461,1.27912193378143,1.28139313300825,1.28366433223507,1.28593553146189,1.28820673068871,1.29047792991553,1.29274912914235,1.29502032836917,1.29729152759599,1.2995627268228,1.30183392604962,1.30410512527644,1.30637632450326,1.30864752373008,1.3109187229569,1.31318992218372,1.31546112141054,1.31773232063736,1.32000351986418,1.322274719091,1.32454591831782,1.32681711754464,1.32908831677146,1.33135951599828,1.3336307152251,1.33590191445192,1.33817311367874,1.34044431290555,1.34271551213237,1.34498671135919,1.34725791058601,1.34952910981283,1.35180030903965,1.35407150826647,1.35634270749329,1.35861390672011,1.36088510594693,1.36315630517375,1.36542750440057,1.36769870362739,1.36996990285421,1.37224110208103,1.37451230130785,1.37678350053467,1.37905469976149,1.38132589898831,1.38359709821512,1.38586829744194,1.38813949666876,1.39041069589558,1.3926818951224,1.39495309434922,1.39722429357604,1.39949549280286,1.40176669202968,1.4040378912565,1.40630909048332,1.40858028971014,1.41085148893696,1.41312268816378,1.4153938873906,1.41766508661742,1.41993628584424,1.42220748507106,1.42447868429787,1.42674988352469,1.42902108275151,1.43129228197833,1.43356348120515,1.43583468043197,1.43810587965879,1.44037707888561,1.44264827811243,1.44491947733925,1.44719067656607,1.44946187579289,1.45173307501971,1.45400427424653,1.45627547347335,1.45854667270017,1.46081787192699,1.46308907115381,1.46536027038062,1.46763146960744,1.46990266883426,1.47217386806108,1.4744450672879,1.47671626651472,1.47898746574154,1.48125866496836,1.48352986419518};

// Initialization
int8_t 	findPoles(void);
void   	mitInitCurrentController(Act_s *actx);
void	mitInitOpenController(Act_s *actx);
void 	mitInitPositionController(void);


// Sensor values
void  updateSensorValues(struct act_s *actx);
void setMotorNeutralPosition(struct act_s *actx);
float getAxialForceMotorCurrent(struct act_s *actx);

//Control outputs
float biomCalcImpedance(Act_s *actx, float k1, float b, float theta_set); 	// returns a desired joint torque, then use setMotorTorque() to get the motor to do its magic
float getImpedanceTorque(Act_s *actx, float k1, float b, float thetaSet);	// Returns a Torque Value
float getImpedanceTorqueParams(Act_s *actx, GainParams *gParams);	// Returns a Torque Value
float getImpedanceTorqueQuadratic(Act_s *actx, float k1, float b, float thetaSet, float k2);	// Returns a Torque Value
void  setMotorTorque(struct act_s *actx);
void  setMotorTorqueOpenLoop(struct act_s *actx, float tau_des, int8_t motorControl);
float getCompensatorPIDOutput(float refTorque, float sensedTorque, Act_s *act1);

float getFeedForwardTerm(float refTorque);
float getReferenceLPF(float refTorque, int8_t reset);
float getNotchFilter(float refTorque);
float getCompensatorCustomOutput(float refTorque, float sensedTorque);									// calculate compensator output value
//float getCompensatorCustomOutput2(Act_s *actx, float tauMeas, float tauRef);									// calculate compensator output value
float getDOB(float refTorque, float measTorque);
float getDobLpf(float refTorque);
float getDoBInv(float refTorque);

void  setActuatorTestingTorque(Act_s *actx, ActTestSettings *testInput);

float getTorqueSystemIDFrequencySweepChirp( ActTestSettings *testInput);
float getSinusoidalAngle( struct actTestSettings *testInput);

void setActuatorStepResponse(Act_s *actx, ActTestSettings *testInput);

void  setMotorTorqueOpenLoopVolts(struct act_s *actx, float tau_des);
float torqueSystemIDFrequencySweep(float omega, uint32_t signalTimer, float amplitude, float dcBias, float noiseAmp, int16_t begin);
float torqueSystemIDFrequencySweepChirp(float initOmega,  float finalOmega, float testLength, float amplitude, float dcBias, float noiseAmp, int16_t chirpType, int16_t running);
float torqueSystemIDPRBS(void);
bool integralAntiWindup(float tau_err, float tau_C_total, float tau_C_output); // integral term anti-windup clamp check
float actuateAngleLimits(Act_s *actx);	// apply virtual spring/damper on angle limits
int32_t noLoadCurrent(float desCurr);

extern int8_t fsm1State;

#endif //INC_ACTUATOR_FUNCTIONS_H
